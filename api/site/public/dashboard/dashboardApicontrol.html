<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/style_dash.css">
    <link rel="shortcut icon" type="imagex/png" href="../assets/icon/Logo-ApiControl.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title>Dashboard</title>
</head>

<!-- Chama função para validar a última posição do vetor logo após a função adicionar colméia. -->
<body onload="buscarColmeias()">

    <!-- Header -->
    <div class="header" id="header">
        <img src="../assets/imgs/Logo ApiControl.png">
        <a class="logo">ApiControl</a>
          <div class="header-left">
            <a href="#" onclick="faleConosco()">Fale Conosco</a>
          </div>

          <!-- <div id="iframeContainer" class="pop-up">
            <div  class="Dash">
              <span class="fechar" onclick="fecharHelpDesk()">X</span>
              <iframe width="500px" height="400px" src="https://app.pipefy.com/public/form/F2Ilnzra?embedded=true"
                frameborder="0"></iframe>
            </div>
          </div> -->

          <div class="dropdown">
            <img src="../assets/imgs/user_icon.png">
            <button class="dropbtn" onclick="myFunction()">Usuário
              <i class="fa fa-caret-down"></i>
            </button>
              <div class="dropdown-content" id="myDropdown">
                <a href="../cadastro.html">Cadastrar</a>
                <a href="../login.html" onclick="deslogar()">Deslogar</a>
              </div>
            </div>
    </div>

    <!-- conteúdo da dashboard -->
    <div class="painel">
        <div class="kpi">
            <h1>
                Colmeias
            </h1>
            <div class="lista_colmeias">
                <ol id="colmeias">
                </ol>
                <ol id="colmeias2">

                </ol>
            </div>
        </div>
        
        <div class="container" style="display: flex;" id="holder">
          <div class="container-analytics">
            <div class="btn-group">
              <button class="btnF1">26ºC Emergência</button>
              <button class="btnF2">27ºC Crítico</button>
              <button class="btnF3">28ºC Alerta</button>
              <button class="btnI">29ºC Ideal 35ºC</button>
              <button class="btnQ3">Alerta 36ºC</button>
              <button class="btnQ2">Crítico 37ºC</button>
              <button class="btnQ1">Emergência 38ºC</button>
            </div>
          </div>
          <br>
          <div class="container-analytics">
            <div class="btn-group">
              <button class="btnUF1">37% Emergência</button>
              <button class="btnUF2">38% Crítico</button>
              <button class="btnUF3">39% Alerta</button>
              <button class="btnUI">40% Ideal 80%</button>
              <button class="btnUQ3">Alerta 81%</button>
              <button class="btnUQ2">Crítico 82%</button>
              <button class="btnUQ1">Emergência 83%</button>
            </div>
          </div>
              <br>
              <span class="filler" id="filler">Clique em uma das <b>colmeias a esquerda</b> para verificar seu <b>monitoramento</b> <br> e abaixo <br> Os <b>relatórios</b> para verificar dados de um <b>período</b> específico</span>
        </div>
        <div class="container" style="display: none;" id="graficos">
          <div class="container-analytics">
            <div class="btn-group">
              <button class="btnF1">26ºC Emergência</button>
              <button class="btnF2">27ºC Crítico</button>
              <button class="btnF3">28ºC Alerta</button>
              <button class="btnI">29ºC Ideal 35ºC</button>
              <button class="btnQ3">Alerta 36ºC</button>
              <button class="btnQ2">Crítico 37ºC</button>
              <button class="btnQ1">Emergência 38ºC</button>
            </div>
          </div>
          <br>
          <div class="container-analytics">
            <div class="btn-group">
              <button class="btnUF1">37% Emergência</button>
              <button class="btnUF2">38% Crítico</button>
              <button class="btnUF3">39% Alerta</button>
              <button class="btnUI">40% Ideal 80%</button>
              <button class="btnUQ3">Alerta 81%</button>
              <button class="btnUQ2">Crítico 82%</button>
              <button class="btnUQ1">Emergência 83%</button>
            </div>
          </div>
              <br>
            <div class="texto_periodo" >
                <!-- <div class="periodos"> -->
                    <!-- <select id="periodo">
                        <option value="tempAtual">Temperatura atual</option> <br>
                        <option value="ult24Horas">Últimas 24 horas</option> <br>
                        <option value="ultSemana">Última semana</option> <br>
                        <option value="ultMes">Último mês</option> <br>
                        <option value="ultAno">Último ano</option> <br>
                    </select> -->
                <!-- </div> -->
                <h1 style="color: white;" id="title">
                    Monitoramento da Colmeia (Ultimas capturas de dados)
                </h1>
                <div class="alert">
                  <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
                  <strong>Perigo!</strong> A temperatura está muito fora do ideal, as abelhas estão precisando de suporte!
                </div>

                <div class="alertUmid">
                  <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
                  <strong>Perigo!</strong> A umidade está muito fora do ideal, as abelhas estão precisando de suporte!
                </div>
            </div>
            <div class="titulo" style="display: flex;">
                    <div class="container-chart chart">
                        <canvas id="myChart" style="position: relative; height: 120px; width: 180px;"></canvas>
                    </div>
                
                    <div class="container-chart chart">
                        <canvas id="myChart2" style="position: relative; height: 120px; width: 180px;"></canvas>
                    </div>
            </div>
            <div class="texto_periodo" >
              <h1 style="color: white;" id="title">
                Relatório anual
              </h1>
          </div>
              <div class="titulo" style="display: flex;">
                      <div class="container-chart chart">
                          <canvas id="myChart3" style="position: relative; height: 120px; width: 180px;"></canvas>
                      </div>
                  
                      <div class="container-chart chart">
                          <canvas id="myChart4" style="position: relative; height: 120px; width: 180px;"></canvas>
                      </div>
              </div>
        </div>
    </div>
<div id="alerta"></div>
</body>
</html>

<script>
/* Quando o usuário clica no botão,
alternar entre ocultar e mostrar o conteúdo suspenso */
function myFunction() {
  document.getElementById("myDropdown").classList.toggle("show");
}

// Feche o menu suspenso se o usuário clicar fora dele
window.onclick = function(e) {
  if (!e.target.matches('.dropbtn')) {
  var myDropdown = document.getElementById("myDropdown");
    if (myDropdown.classList.contains('show')) {
      myDropdown.classList.remove('show');
    }
  }
}
    const vetor_colmeia = [];
    var colmeia_banco = [];

    function buscarColmeias(num) {
      var fkEmpresa = sessionStorage.FK_EMPRESA

      fetch(`/colmeias/buscar/${fkEmpresa}`, {
        cache: 'no-store'
        }).then(function(response) {

            if(response.ok) {
                response.json().then(function(resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                    inserirColmeias(resposta);

            });
        }else {
            console.error('Nenhum dado encontrado ou erro na API')
        }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`)
        })


    }

    function inserirColmeias(resposta) {

      for(var i=0; i < resposta.length;i++) {
        colmeia_banco.push(resposta[i].idColmeia)
        vetor_colmeia.push(i+1);
      }

      adicionar_colmeia();

    }


    function adicionar_colmeia() {
        contador = 0;
        contador2 = 0;


        for(var i=0; i<vetor_colmeia.length;i++) {
          colmeias.innerHTML += ` 
            <li class="lista_colmeia_item">
              <a onclick = "exibirGraficos(${vetor_colmeia[i] - 1})">
                ${vetor_colmeia[i]}
              </a>             
            <div class="status_colmeia" style="background-color: red;" id="status_${i}"></div>
            </li>
            `

          }
          chamarAtualizar();

    }

    var ultimasTemperaturas = [];
    var ultimasUmidades = [];
    var ultimasLabels = [];
    var numero = 0;
    var mediaTemperaturas = [];
    var mediaUmidades = [];
    var labelMedias = [];
    var mediaTemperaturasOrder = [];
    var mediaUmidadesOrder = [];
    var labelMediasOrder = [];

    var contReq = 0;
    var contReqAtualizar = 0;

    function chamarAtualizar() {

      if(contReq < colmeia_banco.length) {
        atualizarTemperaturas(colmeia_banco[contReq]);        
      } else {
          // setTimeout(atuallizarTempoRealTemp, 5000);
          buscarMediasAnuais();
          atualizarTempoRealTemp();
      }
      
    }

    function atualizarTemperaturas(num) {
      var fkEmpresa = sessionStorage.FK_EMPRESA;
      var sensor = 1

      fetch(`/medidas/ultimas/`, {
        headers: {
          "id": num,
          "sensor": sensor
        },
        cache: 'no-store'
        }).then(function(response) {

            if(response.ok) {
                response.json().then(function(resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    var vetorLabels = [];
                    var vetorTemperaturas = [];

                    for(var i=0; i<resposta.length;i++) {
                      vetorLabels.push(resposta[i].momento_grafico)
                      vetorTemperaturas.push(resposta[i].valorRegistrado)                      
                    }

                    ultimasTemperaturas.push(vetorTemperaturas);
                    ultimasLabels.push(vetorLabels);

                    atualizarGraficoUmidade(num);

            });
        }else {
            console.error('Nenhum dado encontrado ou erro na API')
        }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`)
        })


    }

    function atualizarGraficoUmidade(num) {
      var sensor = 2;

      fetch(`/medidas/ultimas/`, {
        headers: {
          "id": num,
          "sensor": sensor
        },
        cache: 'no-store'
        }).then(function(response) {

            if(response.ok) {
                response.json().then(function(resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    var vetorUmidade = [];

                  for(var i=0; i<resposta.length;i++) {
                    vetorUmidade.push(resposta[i].valorRegistrado);
                  }

                  ultimasUmidades.push(vetorUmidade);
                  alterarKpis(contReq);
                  contReq++;
                  chamarAtualizar();
            });
        }else {
            console.error('Nenhum dado encontrado ou erro na API')
        }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`)
        })

    }

    function buscarMediasAnuais() {
      var fkEmpresa = sessionStorage.FK_EMPRESA;
      var sensor = 1;

      fetch(`/medidas/medias/`, {
        headers: {
          "id": fkEmpresa,
          "sensor": sensor
        },
        cache: 'no-store'
        }).then(function(response) {

            if(response.ok) {
                response.json().then(function(resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                  for(var i=0; i<resposta.length;i++) {
                    mediaTemperaturas.push(resposta[i].valorRegistrado);
                    labelMedias.push(resposta[i].mes);
                  }

                  for(var i=0; i<mediaTemperaturas.length;i++) {
                    if(labelMedias[i] == 'January 2023') {
                      labelMediasOrder[0] = 'Janeiro'
                      mediaTemperaturasOrder[0] = mediaTemperaturas[i]
                    }else if(labelMedias[i] == 'February 2023') {
                      labelMediasOrder[1] = 'Fevereiro'
                      mediaTemperaturasOrder[1] = mediaTemperaturas[i]
                    }else if(labelMedias[i] == 'March 2023') {
                      labelMediasOrder[2] = 'Março'
                      mediaTemperaturasOrder[2] = mediaTemperaturas[i]
                    }else if(labelMedias[i] == 'April 2023') {
                      labelMediasOrder[3] = 'Abril'
                      mediaTemperaturasOrder[3] = mediaTemperaturas[i]
                    }else if(labelMedias[i] == 'May 2023') {
                      labelMediasOrder[4] = 'Maio'
                      mediaTemperaturasOrder[4] = mediaTemperaturas[i]
                    }else if(labelMedias[i] == 'June 2023') {
                      labelMediasOrder[5] = 'Junho'
                      mediaTemperaturasOrder[5] = mediaTemperaturas[i]
                    }else if(labelMedias[i] == 'July 2023') {
                      labelMediasOrder[6] = 'Julho'
                      mediaTemperaturasOrder[6] = mediaTemperaturas[i]
                    }else if(labelMedias[i] == 'August 2023') {
                      labelMediasOrder[7] = 'Agosto'
                      mediaTemperaturasOrder[7] = mediaTemperaturas[i]
                    }else if(labelMedias[i] == 'September 2023') {
                      labelMediasOrder[8] = 'Setembro'
                      mediaTemperaturasOrder[8] = mediaTemperaturas[i]
                    }else if(labelMedias[i] == 'October 2023') {
                      labelMediasOrder[9] = 'Outubro'
                      mediaTemperaturasOrder[9] = mediaTemperaturas[i]
                    }else if(labelMedias[i] == 'November 2023') {
                      labelMediasOrder[10] = 'Novembro'
                      mediaTemperaturasOrder[10] = mediaTemperaturas[i]
                    }else if(labelMedias[i] == 'December 2023') {
                      labelMediasOrder[11] = 'Dezembro'
                      mediaTemperaturasOrder[11] = mediaTemperaturas[i]
                    }
                  }

                  buscarMediasAnuaisUmidade()
            });
        }else {
            console.error('Nenhum dado encontrado ou erro na API')
        }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`)
        })

    }

    function buscarMediasAnuaisUmidade() {
      var fkEmpresa = sessionStorage.FK_EMPRESA;
      var sensor = 2;

      fetch(`/medidas/medias/`, {
        headers: {
          "id": fkEmpresa,
          "sensor": sensor
        },
        cache: 'no-store'
        }).then(function(response) {

            if(response.ok) {
                response.json().then(function(resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                  for(var i=0; i<resposta.length;i++) {
                    mediaUmidades.push(resposta[i].valorRegistrado);
                  }

                  for(var i=0; i<mediaTemperaturas.length;i++) {
                    if(labelMedias[i] == 'January 2023') {
                      mediaUmidadesOrder[0] = mediaUmidades[i]
                    }else if(labelMedias[i] == 'February 2023') {
                      mediaUmidadesOrder[1] = mediaUmidades[i]
                    }else if(labelMedias[i] == 'March 2023') {
                      mediaUmidadesOrder[2] = mediaUmidades[i]
                    }else if(labelMedias[i] == 'April 2023') {
                      mediaUmidadesOrder[3] = mediaUmidades[i]
                    }else if(labelMedias[i] == 'May 2023') {
                      mediaUmidadesOrder[4] = mediaUmidades[i]
                    }else if(labelMedias[i] == 'June 2023') {
                      mediaUmidadesOrder[5] = mediaUmidades[i]
                    }else if(labelMedias[i] == 'July 2023') {
                      mediaUmidadesOrder[6] = mediaUmidades[i]
                    }else if(labelMedias[i] == 'August 2023') {
                      mediaUmidadesOrder[7] = mediaUmidades[i]
                    }else if(labelMedias[i] == 'September 2023') {
                      mediaUmidadesOrder[8] = mediaUmidades[i]
                    }else if(labelMedias[i] == 'October 2023') {
                      mediaUmidadesOrder[9] = mediaUmidades[i]
                    }else if(labelMedias[i] == 'November 2023') {
                      mediaUmidadesOrder[10] = mediaUmidades[i]
                    }else if(labelMedias[i] == 'December 2023') {
                      mediaUmidadesOrder[11] = mediaUmidades[i]
                    }
                  }

                  
            });
        }else {
            console.error('Nenhum dado encontrado ou erro na API')
        }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`)
        })

    }

    function exibirGraficos(num) {

      botaoClicado = num;
      graficos.style.display = "flex";
      holder.style.display = "none";

      myChart.config.data.labels = ultimasLabels[num];
      myChart2.config.data.labels = ultimasLabels[num];
      myChart.config.data.datasets[0].data = ultimasTemperaturas[num];
      myChart2.config.data.datasets[0].data = ultimasUmidades[num];
      myChart3.config.data.labels = labelMediasOrder;
      myChart3.config.data.datasets[0].data = mediaTemperaturasOrder;
      myChart4.config.data.labels = labelMediasOrder;
      myChart4.config.data.datasets[0].data = mediaUmidadesOrder;


      myChart.update();
      myChart2.update();
      myChart3.update();
      myChart4.update();

    }

    var botaoClicado = -1;

    function atualizarGraficos(num) {

      

      myChart.config.data.labels = ultimasLabels[num];
      myChart2.config.data.labels = ultimasLabels[num];
      myChart.config.data.datasets[0].data = ultimasTemperaturas[num];
      myChart2.config.data.datasets[0].data = ultimasUmidades[num];
      myChart3.config.data.labels = labelMediasOrder;
      myChart3.config.data.datasets[0].data = mediaTemperaturasOrder;
      myChart4.config.data.labels = labelMediasOrder;
      myChart4.config.data.datasets[0].data = mediaUmidadesOrder;


      myChart.update();
      myChart2.update();
      myChart3.update();
      myChart4.update();

    }
  

    function atualizarTempoRealTemp() {
      
      if(contReqAtualizar == 4) {
        contReqAtualizar = 0;
      }

      var idColmeia = colmeia_banco[contReqAtualizar];
      var sensor = 1;
      

      fetch(`/medidas/tempo-real/`, {
        headers: {
          "id": idColmeia,
          "sensor": sensor
        },
        cache: 'no-store'
        }).then(function(response) {

          

            if(response.ok) {
                response.json().then(function(resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                  
                  if(resposta[0].momento_grafico == ultimasLabels[contReqAtualizar][ultimasLabels[contReqAtualizar].length - 1]) {
                    console.log(`Não há dados novos para inserir na colmeia ${colmeia_banco[contReqAtualizar]}`)
                    // alterarKpis(contReqAtualizar)
                    contReqAtualizar++;
                    setTimeout(atualizarTempoRealTemp, 1000)
                  } else {
                    ultimasLabels[contReqAtualizar].shift();
                    ultimasLabels[contReqAtualizar].push(resposta[0].momento_grafico);
                    
                    ultimasTemperaturas[contReqAtualizar].shift();
                    ultimasTemperaturas[contReqAtualizar].push(resposta[0].valorRegistrado);
                    
                    
                    alterarKpis(contReqAtualizar);
                    atualizarTempoRealUmidade()
                  }
                  
            });
        }else {
            console.error('Nenhum dado encontrado ou erro na API')
        }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`)
        })

    }

  //   let alertQueue = [];

  // function alertaQuente() {
  //   const newAlert = Swal.mixin({
  //     toast: true,
  //     position: 'top-end',
  //     showConfirmButton: false,
  //     timer: 1500,
  //     didOpen: () => {
  //       alertQueue.push(newAlert);
  //       updateAlertPositions();
  //     },
  //     didClose: () => {
  //       alertQueue = alertQueue.filter(alert => alert !== newAlert);
  //       updateAlertPositions();
  //     }
  //   });

  //   newAlert.fire({
  //     icon: 'warning',
  //     title: `A colmeia ${vetor_colmeia[contReqAtualizar]} está em estado de emergência!`,
  //     text: 'Ela está muito acima da temperatura ideal!',
  //   });
  // }

  // function updateAlertPositions() {
  //   alertQueue.forEach((alert, index) => {
  //     const topOffset = index * 100; // Adjust this value to set the distance between alerts
  //     alert.setPosition('top-end', topOffset);
  //   });
  // }

    function alertaQuente() {
          Swal.fire({
            position: "top-end",
            icon: "warning",
            title: `A colmeia ${vetor_colmeia[contReqAtualizar]} está em estado de emergência!`,
            text: "Ela está muito acima da temperatura ideal!",
            showConfirmButton: false,
            timer: 5000
          });
    }

  //   function alertaFrio() {
  //   const newAlert = Swal.mixin({
  //     toast: true,
  //     position: 'top-end',
  //     showConfirmButton: false,
  //     timer: 1500,
  //     didOpen: () => {
  //       alertQueue.push(newAlert);
  //       updateAlertPositions();
  //     },
  //     didClose: () => {
  //       alertQueue = alertQueue.filter(alert => alert !== newAlert);
  //       updateAlertPositions();
  //     }
  //   });

  //   newAlert.fire({
  //     icon: 'warning',
  //     title: `A colmeia ${vetor_colmeia[contReqAtualizar]} está em estado de emergência!`,
  //     text: 'Ela está muito abaixo da temperatura ideal!',
  //   });
  // }


    function alertaFrio() {
          Swal.fire({
            position: "top-end",
            icon: "warning",
            title: `A colmeia ${vetor_colmeia[contReqAtualizar]} está em estado de emergência!`,
            text: "Ela está muito abaixo da temperatura ideal!",
            showConfirmButton: false,
            timer: 5000
          });
    }

    function alterarKpis(contReqAtualizar) {

      if(ultimasTemperaturas[contReqAtualizar][ultimasTemperaturas[contReqAtualizar].length - 1] >= 29 &&
          ultimasTemperaturas[contReqAtualizar][ultimasTemperaturas[contReqAtualizar].length - 1] <= 35 ) {
          modificarStatusColmeia(contReqAtualizar, 'ideal');
          } else if(ultimasTemperaturas[contReqAtualizar][ultimasTemperaturas[contReqAtualizar].length-1] > 35 &&
                    ultimasTemperaturas[contReqAtualizar][ultimasTemperaturas[contReqAtualizar].length-1] <= 36) {
                      modificarStatusColmeia(contReqAtualizar, 'alerta');
          } else if(ultimasTemperaturas[contReqAtualizar][ultimasTemperaturas[contReqAtualizar].length-1] > 36 &&
                    ultimasTemperaturas[contReqAtualizar][ultimasTemperaturas[contReqAtualizar].length-1] <= 37) {
                      modificarStatusColmeia(contReqAtualizar, 'critico');
          }else if(ultimasTemperaturas[contReqAtualizar][ultimasTemperaturas[contReqAtualizar].length-1] > 37) {
                      modificarStatusColmeia(contReqAtualizar, 'emergencia');
          }else if(ultimasTemperaturas[contReqAtualizar][ultimasTemperaturas[contReqAtualizar].length-1] < 29 &&
                    ultimasTemperaturas[contReqAtualizar][ultimasTemperaturas[contReqAtualizar].length-1] >= 28) {
                      modificarStatusColmeia(contReqAtualizar, 'alertaFrio');
          }else if(ultimasTemperaturas[contReqAtualizar][ultimasTemperaturas[contReqAtualizar].length-1] < 28 &&
                    ultimasTemperaturas[contReqAtualizar][ultimasTemperaturas[contReqAtualizar].length-1] >= 27) {
                      modificarStatusColmeia(contReqAtualizar, 'criticoFrio');
          }else if(ultimasTemperaturas[contReqAtualizar][ultimasTemperaturas[contReqAtualizar].length-1] < 26) {
                      modificarStatusColmeia(contReqAtualizar, 'emergenciaFrio');
          }

    }

    function atualizarTempoRealUmidade() {
      var idColmeia = colmeia_banco[contReqAtualizar];
      var idBotao = vetor_colmeia[contReqAtualizar] - 1;
      var sensor = 2;

      fetch(`/medidas/tempo-real/`, {
        headers: {
          "id": idColmeia,
          "sensor": sensor
        },
        cache: 'no-store'
        }).then(function(response) {

            if(response.ok) {
                response.json().then(function(resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    ultimasUmidades[contReqAtualizar].shift();
                    ultimasUmidades[contReqAtualizar].push(resposta[0].valorRegistrado);
                  
                    if(botaoClicado == contReqAtualizar) {
                      atualizarGraficos(idBotao);
                    }
                    contReqAtualizar++;
                    setTimeout(atualizarTempoRealTemp, 1000);
            });
        }else {
            console.error('Nenhum dado encontrado ou erro na API')
        }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`)
        })
    }

    function modificarStatusColmeia(colmeia, status) {

      if(colmeia == 0) {
        if(status == 'ideal') {
          status_0.style.backgroundColor = "green";
        }
        if(status == 'alerta') {
          status_0.style.backgroundColor = "rgb(235, 235, 19)";
        }
        if(status == 'critico') {
          status_0.style.backgroundColor = "orange";
        }
        if(status == 'emergencia') {
          status_0.style.backgroundColor = "red";
          alertaQuente();
          // alertDisplay.style.display = 'block';
        }
        if(status == 'alertaFrio') {
          status_0.style.backgroundColor = "rgb(16, 71, 153)";
        }
        if(status == 'criticoFrio') {
          status_0.style.backgroundColor = "rgb(94, 134, 196)";
        }
        if(status == 'emergenciaFrio') {
          status_0.style.backgroundColor = "rgb(45, 238, 255)"
          alertaFrio();
          // btnFrio1.classList.add("blink-emerg");
        }

      }else if(colmeia == 1) {
        if(status == 'ideal') {
          status_1.style.backgroundColor = "green";
        }
        if(status == 'alerta') {
          status_1.style.backgroundColor = "rgb(235, 235, 19)";
        }
        if(status == 'critico') {
          status_1.style.backgroundColor = "orange";
        }
        if(status == 'emergencia') {
          status_1.style.backgroundColor = "red";
          alertaQuente();
          // alertDisplay.style.display = 'block';
        }
        if(status == 'alertaFrio') {
          status_1.style.backgroundColor = "rgb(16, 71, 153)";
        }
        if(status == 'criticoFrio') {
          status_1.style.backgroundColor = "rgb(94, 134, 196)";
        }
        if(status == 'emergenciaFrio') {
          status_1.style.backgroundColor = "rgb(45, 238, 255)";
          alertaFrio();
          // alertDisplay.style.display = 'block';
        }

      }else if(colmeia == 2) {
        if(status == "ideal") {
          status_2.style.backgroundColor = "green";
        }
        if(status == 'alerta') {
          status_2.style.backgroundColor = "rgb(235, 235, 19)";
        }
        if(status == 'critico') {
          status_2.style.backgroundColor = "orange";
        }
        if(status == 'emergencia') {
          status_2.style.backgroundColor = "red";
          alertaQuente();
          // alertDisplay.style.display = 'block';
        }
        if(status == 'alertaFrio') {
          status_2.style.backgroundColor = "rgb(16, 71, 153)";
        }
        if(status == 'criticoFrio') {
          status_2.style.backgroundColor = "rgb(94, 134, 196)";
        }
        if(status == 'emergenciaFrio') {
          status_2.style.backgroundColor = "rgb(45, 238, 255)";
          alertaFrio();
          // alertDisplay.style.display = 'block';
        }

      }else if(colmeia == 3) {
        if(status == "ideal") {
          status_3.style.backgroundColor = "green";
        }
        if(status == 'alerta') {
          status_3.style.backgroundColor = "rgb(235, 235, 19)";
        }
        if(status == 'critico') {
          status_3.style.backgroundColor = "orange";
        }
        if(status == 'emergencia') {
          status_3.style.backgroundColor = "red";
          alertaQuente();
          // alertDisplay.style.display = 'block';
        }
        if(status == 'alertaFrio') {
          status_3.style.backgroundColor = "rgb(16, 71, 153)";
        }
        if(status == 'criticoFrio') {
          status_1.style.backgroundColor = "rgb(94, 134, 196)";
        }
        if(status == 'emergenciaFrio') {
          status_3.style.backgroundColor = "rgb(45, 238, 255)";
          alertaFrio();
          // alertDisplay.style.display = 'block';
        }
      }

    }

    function loadDelayedContent() {
      header.innerHTML += `<div id="iframeContainer" class="pop-up">
            <div  class="Dash">
              <span class="fechar" onclick="fecharHelpDesk()">X</span>
              <iframe width="500px" height="400px" src="https://app.pipefy.com/public/form/F2Ilnzra?embedded=true"
                frameborder="0"></iframe>
            </div>
          </div>`;
    }

    // Delay in milliseconds (5 seconds = 5000ms)
    var delayDuration = 5000; // 5 seconds delay

    // Call the function to load content into the div after the specified delay
    setTimeout(loadDelayedContent, delayDuration);

    var contClick = 0;
    
    const ctw = document.getElementById('myChart4');
    const cty = document.getElementById('myChart3');
    const ctx = document.getElementById('myChart2');
    const ctz = document.getElementById('myChart');


    const myChart = new Chart(ctz, {
      type: 'line',
      data: {
        labels: ['12:00', '13:00', '14:00', '15:00', '16:00', '17:00'],
        datasets: [{
          label: 'Temperatura',
          data: [],
          backgroundColor: 'rgb(255, 99, 132)',
          borderColor: 'rgb(255, 99, 132)',
          borderWidth: 1
        }]
      },
      options: {
        // responsive: true,
        // maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            min: 0,
            max: 50
            // grid: {
            // 	color: '#000',
            // 	drawBorder: false 
            // }
        },
        x: {
          // grid: {
          // 	display: false,
          // }
            }
        }
      }
    });

    const myChart2 = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['12:00', '13:00', '14:00', '15:00', '16:00', '17:00'],
      datasets: [{
        label: 'Umidade',
        data: [],
        backgroundColor: 'rgb(40, 140, 255)',
        borderColor: 'rgb(40, 140, 255)',
        borderWidth: 1
      }]
    },
    options: {
      // responsive: true,
      // maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          min: 0,
          max: 100
          // grid: {
            // 	color: '#000',
            // 	drawBorder: false 
            // }
          },
          x: {
            // grid: {
              // 	display: false,
              // }
            }
          }
        }
      })

      const myChart3 = new Chart(cty, {
      type: 'line',
      data: {
        labels: ['12:00', '13:00', '14:00', '15:00', '16:00', '17:00'],
        datasets: [{
          label: 'Temperatura',
          data: [],
          backgroundColor: 'rgb(255, 99, 132)',
          borderColor: 'rgb(255, 99, 132)',
          borderWidth: 1
        }]
      },
      options: {
        // responsive: true,
        // maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            min: 0,
            max: 50
            // grid: {
            // 	color: '#000',
            // 	drawBorder: false 
            // }
        },
        x: {
          // grid: {
          // 	display: false,
          // }
            }
        }
      }
    });

    const myChart4 = new Chart(ctw, {
    type: 'bar',
    data: {
      labels: ['12:00', '13:00', '14:00', '15:00', '16:00', '17:00'],
      datasets: [{
        label: 'Umidade',
        data: [],
        backgroundColor: 'rgb(40, 140, 255)',
        borderColor: 'rgb(40, 140, 255)',
        borderWidth: 1
      }]
    },
    options: {
      // responsive: true,
      // maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          min: 0,
          max: 100
          // grid: {
            // 	color: '#000',
            // 	drawBorder: false 
            // }
          },
          x: {
            // grid: {
              // 	display: false,
              // }
            }
          }
        }
      })

    //   const myChart3 = new Chart(cty, {
    //   type: 'line',
    //   data: {
    //     labels: ['segunda', 'terça', 'quarta', 'quinta', 'sexta', 'sábado', 'domingo'],
    //     datasets: [{
    //       label: 'Temperatura Média',
    //       data: [],
    //       backgroundColor: 'rgb(255, 99, 132)',
    //       borderColor: 'rgb(255, 99, 132)',
    //       borderWidth: 1
    //     }]
    //   },
    //   options: {
    //     // responsive: true,
    //     // maintainAspectRatio: false,
    //     scales: {
    //       y: {
    //       beginAtZero: true,
    //       // grid: {
    //       // 	color: '#000',
    //       // 	drawBorder: false 
    //       // }
    //     },
    //     x: {
    //       // grid: {
    //       // 	display: false,
    //       // }
    //         }
    //     }
    //   }
    // });
      
    // const myChart4 = new Chart(ctw, {
    //   type: 'line',
    //   data: {
    //     labels: ['segunda', 'terça', 'quarta', 'quinta', 'sexta', 'sábado', 'domingo'],
    //     datasets: [{
    //       label: 'Umidade Média',
    //       data: [],
    //       backgroundColor: 'rgb(40, 140, 255)',
    //       borderColor: 'rgb(40, 140, 255)',
    //       borderWidth: 1
    //     }]
    //   },
    //   options: {
    //     // responsive: true,
    //     // maintainAspectRatio: false,
    //     scales: {
    //       y: {
    //       beginAtZero: true,
    //       // grid: {
    //       // 	color: '#000',
    //       // 	drawBorder: false 
    //       // }
    //     },
    //     x: {
    //       // grid: {
    //       // 	display: false,
    //       // }
    //         }
    //     }
    //   }
    // });
    
    var numClicado = 0;

    // function atualizarGrafico(num) {
      
    //   myChart.config.data.datasets[0].data = listaTemperatura[num];
    //   myChart2.config.data.datasets[0].data = listaUmidade[num];
    //   myChart3.config.data.datasets[0].data = listaTempSem[num];
    //   myChart4.config.data.datasets[0].data = listaUmidSem[num];

    //   myChart.update();
    //   myChart2.update();
    //   myChart3.update();
    //   myChart4.update();

    //   graficos.style.display = "flex";
    //   holder.style.display = "none";
    //   numClicado = num;

    // }

    function periodoGrafico(num) {
      var period = document.getElementById("periodo").value;
      
      if (period == `ultSemana`) {
        // myChart3.data.labels.pop();
        // myChart4.data.labels.pop();
        myChart3.config.data.labels = ['segunda', 'terça', 'quarta', 'quinta', 'sexta', 'sábado', 'domingo'];
        myChart4.config.data.labels = ['segunda', 'terça', 'quarta', 'quinta', 'sexta', 'sábado', 'domingo'];
        myChart3.config.data.datasets[0].data = listaTempSem[num];
        myChart4.config.data.datasets[0].data = listaUmidSem[num];

        myChart3.update();
        myChart4.update();

      } else if (period == `ultMes`) {
        // myChart3.data.labels.pop();
        // myChart4.data.labels.pop();
        myChart3.config.data.labels = ['Janeiro', 'Fevereiro', 'Março', 'Maio', 'Abril', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        myChart4.config.data.labels = ['Janeiro', 'Fevereiro', 'Março', 'Maio', 'Abril', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        myChart3.config.data.datasets[0].data = listaTempMes[num];
        myChart4.config.data.datasets[0].data = listaUmidMes[num];

        myChart3.update();
        myChart4.update();

      }
    }

    // Colmeia 1
    // var listaTemperatura = [[30, 29, 28, 25, 22, 23], [18, 18, 19, 20, 21, 22], [32, 33, 34, 35, 34, 32]]; 
    // var listaUmidade = [[90, 89, 93, 87, 88, 82], [60, 60, 63, 65, 68, 70], [70, 75, 75, 73, 70, 67]];

    // Relatórios
      //Semana
    var listaTempSem = [[25, 26, 26, 25, 26, 29, 25], [16, 18, 24, 17, 16, 18, 19], [24, 28, 29, 25, 26, 27, 26]]; 
    var listaUmidSem = [[80, 82, 81, 85, 87, 90, 93], [60, 62, 64, 63, 64, 62, 61], [70, 72, 73, 75, 73, 80, 82]];

      //Mês
    var listaTempMes = [[30, 27, 25, 25, 28, 29, 27, 28, 26, 25, 28, 25], [16, 18, 24, 17, 16, 18, 19, 20, 18, 17, 16, 20], [24, 28, 29, 25, 26, 27, 26, 23, 25, 26, 28, 27]]; 
    var listaUmidMes = [[80, 82, 81, 85, 87, 90, 93, 91, 88, 84, 80, 82], [60, 62, 64, 63, 64, 62, 61, 63, 65, 62, 64, 60], [70, 72, 73, 75, 73, 80, 82, 79, 80, 77, 75, 71]];

    // Analytics blink alerts
    const btnFrio1 = document.querySelector('.btnF1');
    const btnFrio2 = document.querySelector('.btnF2');
    const btnFrio3 = document.querySelector('.btnF3');
    const btnIdeal = document.querySelector('.btnI');
    const btnQuente3 = document.querySelector('.btnQ3');
    const btnQuente2 = document.querySelector('.btnQ2');
    const btnQuente1 = document.querySelector('.btnQ1');

    const btnUmidFrio1 = document.querySelector('.btnUF1');
    const btnUmidFrio2 = document.querySelector('.btnUF2');
    const btnUmidFrio3 = document.querySelector('.btnUF3');
    const btnUmidIdeal = document.querySelector('.btnUI');
    const btnUmidQuente3 = document.querySelector('.btnUQ3');
    const btnUmidQuente2 = document.querySelector('.btnUQ2');
    const btnUmidQuente1 = document.querySelector('.btnUQ1');

    const emergButtons = document.querySelectorAll('.blink-emerg');
    const critButtons = document.querySelectorAll('.blink-crit');
    const alertButtons = document.querySelectorAll('.blink-alert');
    const idealButtons = document.querySelectorAll('.blink-ideal');
    const alertDisplay = document.querySelector('.alert');
    const alertUmidDisplay = document.querySelector('.alertUmid');


    /* Help-Desk Pipefy */
    function faleConosco() {
    // Obtém o elemento do iframe
    var iframeContainer = document.getElementById("iframeContainer");
    iframeContainer.style.display = "none";

    // Alterna a visibilidade do iframe
    if (iframeContainer.style.display === "none") {
      iframeContainer.style.display = "flex";
    } else {
      iframeContainer.style.display = "none";
    }
  }

  function fecharHelpDesk() {
        document.getElementById('iframeContainer').style.display = 'none';
    }

    // function VerificarAlerta() {
    //   var ultimoValorTemp = myChart.data.datasets[0].data[myChart.data.datasets[0].data.length - 1];
    //   var ultimoValorUmi = myChart2.data.datasets[0].data[myChart2.data.datasets[0].data.length - 1];

    //   emergButtons.forEach(blink => {
    //     blink.classList.remove('blink-emerg');
    //   });

    //   critButtons.forEach(blink => {
    //     blink.classList.remove('blink-crit');
    //   });

    //   alertButtons.forEach(blink => {
    //     blink.classList.remove('blink-alert');
    //   });

    //   idealButtons.forEach(blink => {
    //     blink.classList.remove('blink-ideal');
    //   });

    //   alertDisplay.style.display = 'none';
    //   alertUmidDisplay.style.display = 'none';

    //   if (ultimoValorTemp >= 38) {
    //     btnQuente1.classList.add("blink-emerg");
    //     alertDisplay.style.display = 'block';

    //   } else if (ultimoValorTemp == 37) {
    //     btnQuente2.classList.add("blink-crit");

    //   } else if (ultimoValorTemp == 36) {
    //     btnQuente3.classList.add("blink-alert");

    //   } else if (ultimoValorTemp <= 35 && ultimoValorTemp >= 29) {
    //     btnIdeal.classList.add("blink-ideal");

    //   } else if (ultimoValorTemp == 28) {
    //     btnFrio3.classList.add("blink-alert");

    //   } else if (ultimoValorTemp == 27) {
    //     btnFrio2.classList.add("blink-crit");
      
    //   } else {
    //     btnFrio1.classList.add("blink-emerg");
    //     alertDisplay.style.display = 'block';
    //   }

    //   if (ultimoValorUmi >= 83) {
    //     btnUmidQuente1.classList.add("blink-emerg");
    //     alertUmidDisplay.style.display = 'block';

    //   } else if (ultimoValorUmi == 82) {
    //     btnUmidQuente2.classList.add("blink-crit");

    //   } else if (ultimoValorUmi == 81) {
    //     btnUmidQuente3.classList.add("blink-alert");

    //   } else if (ultimoValorUmi <= 80 && ultimoValorUmi >= 40) {
    //     btnUmidIdeal.classList.add("blink-ideal");

    //   } else if (ultimoValorUmi == 39) {
    //     btnUmidFrio3.classList.add("blink-alert");

    //   } else if (ultimoValorUmi == 38) {
    //     btnUmidFrio2.classList.add("blink-crit");
      
    //   } else {
    //     btnUmidFrio1.classList.add("blink-emerg");
    //     alertUmidDisplay.style.display = 'block';
    //   }
    // }

    // function alertas() {
    //   setInterval(VerificarAlerta, 2000);
    // }

</script>